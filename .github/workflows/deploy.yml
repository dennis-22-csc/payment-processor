name: Deploy Express API to Google Cloud

on:
  push:
    branches:
      - master
  
  workflow_dispatch:
    inputs:
      deployment_target: 
        description: 'The environment to deploy to (e.g., production, staging)'
        required: true
        default: 'production'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Determine & Log Deployment Target
      - name: Determine Target & Log
        run: |
          TARGET="${{ github.event.inputs.deployment_target || 'master-push' }}"
          echo "DEPLOY_TARGET=$TARGET" >> $GITHUB_ENV
          echo "Starting deployment to target: $TARGET"

      # 1. Setup Node.js Environment
      - name: Install Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22.19.0'
          cache: 'npm'

      # 2. Install production dependencies
      - name: Install dependencies
        env:
          NODE_ENV: production
        run: |
          npm install --production
          
      # Create deployment directory on server
      - name: Create deployment directory on server
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            echo "Creating deployment directory..."
            sudo mkdir -p /var/www/express-api/
            sudo chown -R ${{ secrets.GCP_USER }}:www-data /var/www/express-api/
            sudo chmod -R 755 /var/www/express-api/
            echo "Directory created successfully"

      # Copy files to server
      - name: Copy files to server
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          source: "./"
          target: "/var/www/express-api/"
          exclude: ".git, .github, node_modules, *.log"
          overwrite: true

      # SSH into server & deploy
      - name: SSH into server & deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.GCP_HOST }}
          username: ${{ secrets.GCP_USER }}
          key: ${{ secrets.GCP_SSH_KEY }}
          script: |
            set -e
            echo "Starting Express.js API deployment process to target: ${{ env.DEPLOY_TARGET }}"
            
            DEPLOY_PATH="/var/www/express-api/"
            SERVICE_NAME="payment-processor"
            
            # 1. Set correct file permissions
            echo "Setting ownership and permissions on ${DEPLOY_PATH}..."
            sudo chown -R ${{ secrets.GCP_USER }}:www-data ${DEPLOY_PATH}
            sudo chmod -R 755 ${DEPLOY_PATH}
            
            # 2. Install build tools
            echo "Installing build essentials..."
            sudo apt update
            sudo apt install -y build-essential python3
            
            # 2. Create environment file
            echo "Creating environment configuration..."
            sudo tee "${DEPLOY_PATH}.env" > /dev/null <<'ENVFILE'
            NODE_ENV=production
            PORT=3000
            PAYSTACK_SECRET_KEY=${{ secrets.PAYSTACK_SECRET_KEY }}
            ADMIN_PHONE=${{ secrets.ADMIN_PHONE }}
            ENVFILE
            
            sudo chown ${{ secrets.GCP_USER }}:www-data "${DEPLOY_PATH}.env"
            sudo chmod 600 "${DEPLOY_PATH}.env"
            
            # 3. Install production dependencies on server
            echo "Installing production dependencies..."
            cd ${DEPLOY_PATH}
            npm install --production --build-from-source --no-audit --no-fund
           
            sudo systemctl daemon-reload
            sudo systemctl enable ${SERVICE_NAME}
            sudo systemctl restart ${SERVICE_NAME}
            sudo systemctl reload nginx
            echo "Deployment to ${DEPLOY_PATH} completed successfully! Express.js API is live."
            
